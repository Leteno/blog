# 在 Edge 写 test 的感悟与分享

[TOC]



也算是写了 2 年多的 test 了，从一开始被迫要求写 test，到现在尽可能地让自己的 code 能被 test cover 到，也是不小的转变。本篇文章会以转变的感受聊一下 test 的重要性，以及末尾聊一下如何在 chromium 这样的工程写 test。



# Test 的重要性

> 我或许可以知道我现在写的 code 能不能影响到一俩周前的代码，但是我怎么知道会不会影响我一俩年前写的代码？

当你在提交代码的时候，一旦不是新增的功能，而是修改的时候，你有可能需要仔细想一下会不会对"周边" code 造成影响。如果模块够小，你或许可以调试一下，很容易确保不受影响，当模块的体量很大的时候，如果有人告诉你，以前的 code 前人已经写了不少 test 确保它的功能正常，你可以跑一下。如果跑挂了，你不就可以看一下 test 的上下文，了解是不是你有些 corner case 没有考虑到。

（而一般 test 的代码会以精炼为主，目的性很强，你能很方便地了解这个 corner case 的上下文）

所以 test 重要点：校验你新增的 code 有没有影响之前的 code，就算出了问题，你也可以通过 test 快速了解上下文，定位问题。

对 test 的要求：简练，涉及的 case 越小越好。最好一个 test 只校验一件事情。你可以这么理解，100 个小 test vs 一个大杂烩的 test，肯定大杂烩要调试的范围更广，而且还要不断地调试，逐渐缩小范围。

这同时也是小 test 的精妙之处。你可以很快地缩小范围，定位问题



> 随着工作的深入，你会负责多个模块的代码。在你精力有限的情况下，怎么确保后续进入的所有 code （包括同事写的）会不会影响到你负责的模块。

如果你问我我之前负责的模块的具体细节，我可能需要去找文档，看 code，最后才能告诉你。

但是如果你问我这个模块现在还工作正常吗，或是你最近提交的 code 会不会影响到这个模块，我会直接说，我们只要看最近的 test 结果就好了。

是的，一旦你设置好了 test，每次进 code 之前都会跑一次 test，一旦有人弄坏你的功能，其实你可以第一时间知道（因为 test 挂了）你也可以很快定位到是哪个提交导致的（可以看 test 记录，知道最早一次坏是在什么时候）

MS 这边对 test 很看重，一旦 test 挂了，sheriff 会从记录中找到相关的 PR，然后 revert 掉，确保其他人的提交不受影响（test 一直挂，是进不去提交的）

这点在 Edge 中尤为重要。我们定期会从 chromium 中拉取最新的代码，合入主分支。

每周一俩次，每次的合入的 changes 大概是 1000+ 行，怎么确保每一次的合入（入侵），不会影响我们主体的功能？即使我们人数不少，如果每次合入你都非常仔细地去看里面地 code，研究它带来地影响，恐怕里面地投入会很大。

但是如果你有 test，你可以很直观地知道这次地合入，会坏掉哪些功能。试想一下没有 test 地情况，合入几周后，某个功能出现故障，你都不知道是哪个提交引入的，只能人工一步步查，这投入的人力，恐怕也不少。

归总一下，test 能够确保你的模块的安全，不受他人提交的袭扰，让你能够第一时间发现问题，知道引入问题的代码，就像一个机器人卫兵，保护你的代码，让你可以投入很小的精力关注度的情况下，保证你的代码正常工作。真是太环保不费人了。



# 在 Chromium 中写 test

> 意识先于行动，但是有时候难以实施，导致行动放弃

作者在 java 层或是 c++ 层都写过 test。在 chromium 写 test，比较难的地方是，对于 api 的不熟（毕竟 api 太多了），怎么把测试的想法，用代码实现。比如，你需要添加一个 WebContentsObserver, 你需要验证添加了之后，某个网页元素会被过滤掉。怎么在 test 里面创建 WebContents，怎么样添加 observer，什么样的 code 能够查询网页元素是否存在。比如你还要考虑 feature flag on/off 的情况，怎么在测试代码中添加 feature flag on/off 的代码。

对我有限的经验总结了几点：

* 能不能提前了解 test 框架，比如 java 层的，了解一下 Espresso, xUnit，C++ 的，了解一下 gtest, gmock. 这样至少遇到怎么样验证某个回调会不会被调到，参数是不是预料的，就会反应用 gmock，以及怎么配胸有成竹。

* 问同事。问人总是最直接的法子。Chromium 过于小众，Stackoverflow 是帮不上了。万一同事知道了，反手甩给你一个他之前的提交，你看着他的代码，甚至连一些生僻的 api 也告诉你了，依葫芦画瓢，这不就写出来了吗？

* 看 Chromium。这也是我做得最多的（我会说我是我们组写 test 最多的人吗（逃）

  cs.chromium.org 是一个很不错的搜索 chromium 代码的网站。怎么搜呢？以上文为例，我可能会先搜 WebContentsObserver, 找到其中一个例子，然后看他相对应的 test 是怎么写。多看几个例子。这样自然把 WebContentsObserver 里面所有的基本操作了解个遍。

  比如搜索到的 WebContentsObserver 的例子里面找不到 "检查网页元素" 的例子，怎么办？

  我会去看 WebContentsObserver.h 或是 WebContents.h 里面的 api，有没有合适的，在 cs.chromium.org 中，你又很方便地看到使用这些 api 的位置。这也是我写 test 的一个收获，我感觉我的代码搜索能力比以前强了不少。

耐心（不仅包括你，还包括你的老板），认真，合适的方法，你会找到写 test 的路，相信我，当你写完，你会如同发现新大陆般，富有成就感。

